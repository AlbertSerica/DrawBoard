<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>画板</title>
    <link type="text/css" rel="stylesheet" href="app/css/materialize.css" media="screen,projection" />
    <!-- <script>
        window.nodeRequire = require;
        delete window.require;
        delete window.exports;
        delete window.module;
    </script> -->
    <script type="text/javascript" src="app/js/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="app/js/materialize.min.js"></script>
    <script type="text/javascript" src="app/js/draw.js"></script>
    <style>
        canvas {
            display: block;
            cursor: pointer;
            background-color: #FFFFFF;
            border: 1px solid #CCCCCC;
            max-width: 100%;
        }
        #presets .card-panel{
            cursor: pointer;
        }
        
    </style>
</head>

<body>
    <div id="toolbar" class="row">
        <div class="col s12">
            <div class="card hoverable">
                <div class="card-content">
                    <button data-target="new" id="new-trigger" button class="waves-effect waves-light btn blue-grey hoverable modal-trigger">新建</button>
                    <button id="revoke" class="waves-effect waves-light btn blue-grey hoverable">撤销</button>
                    <button id="save" class="waves-effect waves-light btn blue-grey hoverable">保存</button>
                    <button id="clear" class="waves-effect waves-light btn red hoverable">清空</button>
                </div>
                <div class="card-tabs">
                    <ul class="tabs tabs-fixed-width">
                        <li class="tab"><a class="active" href="#shapes">绘制</a></li>
                        <li class="tab"><a href="#styles">样式</a></li>
                        <li class="tab"><a href="#test6">其他</a></li>
                    </ul>
                </div>
                <div class="card-content grey lighten-4">
                    <div id="shapes">
                        <div class="row" id="shape-type">
                            <div class="col s8" >
                                <button class="waves-effect waves-light btn blue darken-1" data-shape="line">直线</button>
                                <button class="waves-effect waves-light btn blue darken-1" data-shape="rect">矩形</button>
                                <button class="waves-effect waves-light btn blue darken-1" data-shape="circle">圆</button>
                              
                                <button class="waves-effect waves-light btn blue darken-1" id="poly" data-shape="poly">多边形</button>
                                <span class="input-field range-field inline" id="edge" style="display:none;">
                                    <span>边数</span>
                                    <input type="range" id="edge-num" value="1" min="3" max="10" >
                                </span>
            
                                <button class="waves-effect waves-light btn teal darken-1" data-shape="pen">铅笔</button>
                            </div>
                            <div class="col s4">
                                <button class="waves-effect waves-light btn blue darken-1" data-shape="eraser">橡皮</button>
                            </div>
                        </div>
                    </div>
                    <div id="styles">
                        <div class="row">
                            <div class="col s4">
                                <span class="waves-effect waves-light btn grey darken-1">线条色<input  id="stroke-color" type="color" name="color" value="#000000"></span> 
                               
                            </div>
                            <div class="col s4">
                                <form id="stroke-fill-style-picker">
                                    <input type="checkbox" class="filled-in" id="enable-border" checked="checked" />
                                    <label for="enable-border">边框</label>
                                    <input type="checkbox" class="filled-in" id="enable-fill" checked="checked" />
                                    <label for="enable-fill">填充</label>
                                </form>
                                <span class="waves-effect waves-light btn grey darken-1" >填充色
                                    <input id="fill-color" type="color" name="color" value="#ffffff">
                                </span>
                            </div>
                            <div class="col s4">
                                
                                <span class="range-field inline input-field">  
                                        <span>线宽</span>  
                                    <input type="range" id="line-width" value="3" min="1" max="100" >
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="draw-board" class="row">
        <div class="col s12">
            <canvas id="canvas" class="hoverable"></canvas>
        </div> 
    </div>
    <div id="new" class="modal modal-fixed-footer">
        <div class="modal-content">
            <div class="row">
                <h3>新建画布</h3>
            </div>
            <div class="row">
                <div class="col s6">
                    <div class="row">
                        <div class="input-field inline">
                            <input id="customize-canvas-width" type="number" value="1" min="1" class="validate">
                            <label for="customize-canvas-width">宽度</label>
                        </div>
                        <span>像素</span>
                    </div>
                    <div class="row">
                        <div class="input-field inline">
                            <input id="customize-canvas-height" type="number" value="1" min="1" class="validate">
                            <label for="customize-canvas-height">高度</label>
                        </div>
                        <span>像素</span>
                    </div>
                </div>
            </div>
            <div class="row" id="presets">
                <div class="col s4">
                    <div class="card-panel grey hoverable" data-width="500" data-height="500">
                        <p class="white-text center-align">插画</p>
                        <p class="white-text center-align">500 * 500</p>
                    </div>
                </div>
                <div class="col s4">
                    <div class="card-panel grey hoverable"  data-width="1024" data-height="768">
                        <p class="white-text center-align">小网页</p>
                        <p class="white-text center-align">1024 * 768</p>
                    </div>
                </div>
                <div class="col s4">
                    <div class="card-panel grey hoverable"  data-width="840" data-height="1188">
                        <p class="white-text center-align">A4比例</p>
                        <p class="white-text center-align">840 * 1188</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
          <button class="modal-action modal-close waves-effect waves-green btn-flat">取消</button>
          <button class="modal-action modal-close waves-effect waves-green btn-flat" id="customize-confirm">确定</button>
        </div>
      </div>
</body>
<script>
    var settings = {
        "shape":"pen",
        "lineWidth":3,
        "edgeNum":3,
        "strokeFillStyle":"strokeFill",
        "strokeColor":"#000",
        "fillColor":"#fff", 
        "customizeCanvas":false,
        "customizeCanvasWidth":0,
        "customizeCanvasHeight":0,
    }

    $(function(){
        //Initialize modals
        $('.modal').modal({
            dismissible: true, // Modal can be dismissed by clicking outside of the modal
            opacity: .5, // Opacity of modal background
            inDuration: 300, // Transition in duration
            outDuration: 200, // Transition out duration
            startingTop: '4%', // Starting top style attribute
            endingTop: '10%', // Ending top style attribute
            }
        );
        //Initialize the App: Canvas & Settings
        var history = [];
        var canvas=document.getElementById("canvas");
        var context = canvas.getContext("2d");

        function setCanvas(width,height){
            canvas.width=width;
            canvas.height=height;
        }
       

        setCanvas(document.body.clientWidth,document.documentElement.clientHeight-$("#draw-board").offset().top-20);
        $(window).resize(function(){ 
            if(!settings.customizeCanvas){
                setCanvas(document.body.clientWidth,document.documentElement.clientHeight-$("#draw-board").offset().top-20);
                // canvas.width= document.body.clientWidth;
                // canvas.height= document.documentElement.clientHeight-$("#draw-board").offset().top-20;
            }
            if (history.length != 0) { 
                context.putImageData(history[history.length - 1], 0, 0, 0, 0, canvas.width, canvas.height);//显示最后一次保存的快照
            }
        });
        

       
        //Poly Control
        $("#poly").click(function(e){
            $("#edge").show();
        });
        $("#edge").mouseleave(function(){
            $("#edge").hide();
        });

        //Style Toggle
        $("#shape-type button").each(function(index,ele){
            $(ele).click(function(){
                $("#shape-type button").removeClass("teal").addClass("blue");
                $(this).removeClass("blue").addClass("teal");
                settings.shape=$(this).attr("data-shape");
                if(settings.shape!="poly"){
                    $("#edge").hide();
                }
            })
        });
        $("#new-trigger").click(function(){
            $("#customize-canvas-width").val(canvas.width);
        $("#customize-canvas-height").val(canvas.height);
        })
        //Settings
        $("#stroke-color").change(function(){
            settings.strokeColor=$(this).val();
        });
        $("#fill-color").change(function(){ 
            settings.fillColor=$(this).val(); 
        });
        $("#line-width").change(function(){
            settings.lineWidth=$(this).val();
        });
        $("#edge-num").change(function(){
            settings.edgeNum=$(this).val();
        });
        $("#presets .card-panel").each(function(index,ele){
            $(ele).click(function(){
                $("#presets .card-panel").removeClass("teal").addClass("grey");
                $(this).removeClass("grey").addClass("teal");
                settings.customizeCanvasWidth=$(this).attr("data-width");
                settings.customizeCanvasHeight=$(this).attr("data-height");
                $("#customize-canvas-width").val(settings.customizeCanvasWidth);
                $("#customize-canvas-height").val(settings.customizeCanvasHeight);
                $("#customize-confirm").removeAttr("disabled");
            })
        });
        //Validator
        $("#customize-canvas-width").change(function(){
            $("#presets .card-panel").each(function(index,ele){
                $("#presets .card-panel").removeClass("teal").addClass("grey");
            });
            settings.customizeCanvasWidth=$(this).val();
            if((settings.customizeCanvasWidth>0)&&(settings.customizeCanvasHeight>0)){
                $("#customize-confirm").removeAttr("disabled");
            }
            else{
                $("#customize-confirm").attr("disabled","disabled");
            }
        });
        $("#customize-canvas-height").change(function(){
            $("#presets .card-panel").each(function(index,ele){
                $("#presets .card-panel").removeClass("teal").addClass("grey");
            });
            settings.customizeCanvasHeight=$(this).val();
            if((settings.customizeCanvasWidth>0)&&(settings.customizeCanvasHeight>0)){
                $("#customize-confirm").removeAttr("disabled");
            }
            else{
                $("#customize-confirm").attr("disabled","disabled");
            }
        });
        //Customize Canvas
        $("#customize-confirm").click(function(e){
            if((settings.customizeCanvasWidth>0)&&(settings.customizeCanvasHeight>0)){
                settings.customizeCanvas=true;
                setCanvas(settings.customizeCanvasWidth,settings.customizeCanvasHeight);
                // canvas.width=settings.customizeCanvasWidth;
                // canvas.height=settings.customizeCanvasHeight;
            }
            else{
                e.preventDefault();
                settings.customizeCanvasWidth=0;
                settings.customizeCanvasHeight=0;
            }
        });
        $("#stroke-fill-style-picker").change(function(){
            if($("#enable-border").is(":checked")){
                if($("#enable-fill").is(":checked")){
                    $("#enable-border").removeAttr("disabled");
                    $("#enable-fill").removeAttr("disabled");
                    settings.strokeFillStyle="strokeFill";
                    return;
                }
                else{
                    $("#enable-fill").removeAttr("disabled");
                    $("#enable-border").attr("disabled","disabled");
                    settings.strokeFillStyle="stroke";
                    return;
                }
            }
            else if($("#enable-fill").is(":checked")){
                if($("#enable-border").is(":checked")){
                    $("#enable-border").removeAttr("disabled");
                    $("#enable-fill").removeAttr("disabled");
                    settings.strokeFillStyle="strokeFill";
                    return;
                }
                else{
                    $("#enable-border").removeAttr("disabled");
                    $("#enable-fill").attr("disabled","disabled");
                    settings.strokeFillStyle="fill";
                    return;
                }
            }
        })
        //Tool Bar
        $("#revoke").click(function(){
            history.pop();
            context.clearRect(0,0,canvas.width,canvas.height);
            if(history.length>0){
                context.putImageData(history[history.length-1],0,0,0,0,canvas.width,canvas.height);
            }
        })
        $("#save").click(function(){
            var reg=canvas.toDataURL("image/png");
            //var reg=canvas.toDataURL("image/png").replace("image/png","image/octet-stream");//直接自动保存下载
            location.href=reg;
        })
        $("#clear").click(function(){
            history=[];
            context.clearRect(0,0,canvas.width,canvas.height);
        })

        var startX, startY, currentX, currentY;
        var lx, ly, lw, lh;
        canvas.onmousedown = function (e) {//按下鼠标
            startX = e.offsetX;//按下鼠标时的位置
            startY = e.offsetY;
            if (settings.shape == "pen") {
                context.beginPath();
                context.moveTo(startX, startY);//按下鼠标时的位置 设置为起点
            }
            if (settings.shape == "eraser") {
                context.clearRect(startX - 5, startY - 5, 10, 10);
            }
            // if (cutflag && settings.shaple == "cut") {
            //     if (history.length != 0) {
            //         history.splice(-1, 1);
            //     }
            // }
            var draw = new Draw(context, { 
                strokeFillStyle: settings.strokeFillStyle, 
                strokeColor: settings.strokeColor, 
                fillColor:settings.fillColor,
                width: settings.lineWidth 
            });//实例化构造函数
            canvas.onmousemove = function (e) {
                currentX = e.offsetX;//移动中的位置
                currentY = e.offsetY;
                if (settings.shape != "eraser") {
                    context.clearRect(0, 0, canvas.width,canvas.height);//清屏，实现动态绘制
                    if (history.length != 0) {
                        context.putImageData(history[history.length - 1], 0, 0, 0, 0, canvas.width, canvas.height);//显示最后一次保存的快照
                    }
                }
                // if (cutflag && settings.shape == "cut") {
                //     if (iscut) {
                //         context.clearRect(lx, ly, lw - lx, lh - ly);
                //     }
                //     var nx = lx + (currentX - startX);
                //     var ny = ly + (currentY - startY);
                //     context.putImageData(cutdata, nx, ny);
                // } else 
                if (settings.shape == "poly") {
                    draw[settings.shape](startX, startY, currentX, currentY, settings.edgeNum);
                } else {
                    draw[settings.shape](startX, startY, currentX, currentY);
                }
            }
            document.onmouseup = function () {
                canvas.onmousemove = null;
                document.onmouseup = null;
                // if (settings.shape == "cut") {
                //     if (!cutflag) {
                //         cutflag = true;
                //         cutdata = context.getImageData(startX + 1, startY + 1, currentX - startX - 2, currentY - startY - 2);
                //         lx = startX; ly = startY; lw = currentX; lh = currentY;
                //         container.css({ display: "none" });
                //     } else {
                //         cutflag = false;
                //         container.css({ display: "block" });
                //     }
                // }
                history.push(context.getImageData(0, 0, canvas.width, canvas.height));
            }
        }
    })
</script>

</html>
